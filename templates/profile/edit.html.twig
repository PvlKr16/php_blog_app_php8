{% extends 'base.html.twig' %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .current-avatar-preview {
            max-width: 200px;
            margin-bottom: 15px;
            border-radius: 8px;
        }

        .avatar-upload-area {
            border: 2px dashed #b0b0b0;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background-color: #f9f9f9;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .avatar-upload-area.dragover {
            border-color: #4a4a4a;
            background-color: #e8e8e8;
        }

        .avatar-upload-area:hover {
            border-color: #4a4a4a;
            background-color: #f0f0f0;
        }

        .avatar-preview {
            max-width: 200px;
            max-height: 200px;
            margin: 15px auto;
            display: none;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .avatar-upload-icon {
            font-size: 48px;
            color: #8c8c8c;
            margin-bottom: 10px;
        }

        .file-info {
            margin-top: 10px;
            font-size: 14px;
            color: #6c6c6c;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header">
                    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h3>
                </div>
                <div class="card-body">
                    {{ form_start(form, {'attr': {'enctype': 'multipart/form-data', 'id': 'profile-form'}}) }}

                    {{ form_row(form.username) }}
                    {{ form_row(form.email) }}

                    <hr>

                    <div class="mb-3">
                        <label class="form-label">–¢–µ–∫—É—â–∏–π –∞–≤–∞—Ç–∞—Ä</label>
                        <div>
                            {% if user.avatar %}
                                <img src="/uploads/avatars/{{ user.avatar }}" alt="Avatar" class="current-avatar-preview" id="currentAvatar">
                                <form method="post" action="{{ path('profile_avatar_delete') }}" style="display: inline-block;">
                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∞–≤–∞—Ç–∞—Ä?');">
                                        –£–¥–∞–ª–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
                                    </button>
                                </form>
                            {% else %}
                                <p class="text-muted">–ê–≤–∞—Ç–∞—Ä –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–π –∞–≤–∞—Ç–∞—Ä</label>

                        <div class="avatar-upload-area" id="dropZone">
                            <div class="avatar-upload-icon">üì∑</div>
                            <p class="mb-2"><strong>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—é–¥–∞</strong></p>
                            <p class="text-muted mb-2">–∏–ª–∏</p>
                            <button type="button" class="btn btn-secondary btn-sm" id="chooseFileBtn">
                                –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                            </button>
                            <img id="avatarPreview" class="avatar-preview" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä">
                            <div id="fileInfo" class="file-info"></div>
                        </div>

                        <div style="display: none;">
                            {{ form_widget(form.avatarFile) }}
                        </div>

                        <div class="form-text">JPG, PNG, GIF, WEBP. –ú–∞–∫—Å. 5 –ú–ë</div>
                        {{ form_errors(form.avatarFile) }}
                    </div>

                    <hr>

                    {{ form_row(form.birthDate) }}
                    {{ form_row(form.address) }}
                    {{ form_row(form.about) }}

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                        <a href="{{ path('profile_view') }}" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
                    </div>
                    {{ form_end(form) }}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script>
        window.addEventListener('load', function() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.querySelector('input[type="file"][name*="avatarFile"]');
            const chooseFileBtn = document.getElementById('chooseFileBtn');
            const preview = document.getElementById('avatarPreview');
            const fileInfo = document.getElementById('fileInfo');
            const currentAvatar = document.getElementById('currentAvatar');

            if (!dropZone || !fileInput || !chooseFileBtn) {
                console.error('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã!');
                return;
            }

            // –°–∫—Ä—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π input
            fileInput.style.display = 'none';

            // –ö–Ω–æ–ø–∫–∞ "–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª"
            chooseFileBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                fileInput.click();
            });

            // –ö–ª–∏–∫ –ø–æ –∑–æ–Ω–µ
            dropZone.addEventListener('click', function(e) {
                if (e.target.id !== 'chooseFileBtn' && !e.target.closest('#chooseFileBtn')) {
                    fileInput.click();
                }
            });

            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ input
            fileInput.addEventListener('change', function(e) {
                if (e.target.files && e.target.files.length > 0) {
                    handleFiles(e.target.files);
                }
            });

            // Drag & Drop —Å–æ–±—ã—Ç–∏—è
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);

                document.body.addEventListener(eventName, function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });

            dropZone.addEventListener('dragenter', function(e) {
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragover', function(e) {
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', function(e) {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', function(e) {
                dropZone.classList.remove('dragover');

                const dt = e.dataTransfer;
                const files = dt.files;

                if (files.length > 0) {
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(files[0]);
                    fileInput.files = dataTransfer.files;

                    handleFiles(files);
                }
            });

            function handleFiles(files) {
                if (files.length === 0) {
                    return;
                }

                const file = files[0];

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
                if (!file.type.match('image.*')) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                    fileInput.value = '';
                    return;
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º 5 –ú–ë');
                    fileInput.value = '';
                    return;
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
                const fileSizeKB = (file.size / 1024).toFixed(2);
                fileInfo.innerHTML = '<strong>' + file.name + '</strong><br>' + fileSizeKB + ' –ö–ë';

                // –°–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –∞–≤–∞—Ç–∞—Ä, –µ—Å–ª–∏ –µ—Å—Ç—å
                if (currentAvatar) {
                    currentAvatar.style.display = 'none';
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –Ω–æ–≤–æ–≥–æ
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.onerror = function(e) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞:', e);
                };
                reader.readAsDataURL(file);
            }
        });
    </script>
{% endblock %}