{% extends 'base.html.twig' %}

{% block title %}–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è{% endblock %}

{% block stylesheets %}
    <style>
        .avatar-upload-area {
            border: 2px dashed #b0b0b0;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background-color: #f9f9f9;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 15px;
            position: relative;
        }

        .avatar-upload-area.dragover {
            border-color: #4a4a4a;
            background-color: #e8e8e8;
        }

        .avatar-upload-area:hover {
            border-color: #4a4a4a;
            background-color: #f0f0f0;
        }

        .avatar-preview {
            max-width: 200px;
            max-height: 200px;
            margin: 15px auto;
            display: none;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .avatar-upload-icon {
            font-size: 48px;
            color: #8c8c8c;
            margin-bottom: 10px;
        }

        .file-info {
            margin-top: 10px;
            font-size: 14px;
            color: #6c6c6c;
        }

        #avatar-input {
            display: none !important;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
                </div>
                <div class="card-body">
                    {{ form_start(registrationForm, {'attr': {'id': 'registration-form', 'enctype': 'multipart/form-data'}}) }}
                    {{ form_row(registrationForm.username) }}
                    {{ form_row(registrationForm.email) }}
                    {{ form_row(registrationForm.password.first) }}
                    {{ form_row(registrationForm.password.second) }}

                    <div class="mb-3">
                        <label class="form-label">–ê–≤–∞—Ç–∞—Ä (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>

                        <div class="avatar-upload-area" id="dropZone">
                            <div class="avatar-upload-icon">üì∑</div>
                            <p class="mb-2"><strong>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—é–¥–∞</strong></p>
                            <p class="text-muted mb-2">–∏–ª–∏</p>
                            <button type="button" class="btn btn-secondary btn-sm" id="chooseFileBtn">
                                –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                            </button>
                            <img id="avatarPreview" class="avatar-preview" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä">
                            <div id="fileInfo" class="file-info"></div>
                        </div>

                        <div style="display: none;">
                            {{ form_widget(registrationForm.avatar) }}
                        </div>

                        <div class="form-text">JPG, PNG, GIF, WEBP. –ú–∞–∫—Å. 5 –ú–ë. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 200x200px - 1000x1000px</div>
                        {{ form_errors(registrationForm.avatar) }}
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                    </div>
                    {{ form_end(registrationForm) }}

                    <div class="mt-3 text-center">
                        <p>–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="{{ path('login') }}">–í–æ–π—Ç–∏</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script>
        console.log('JavaScript –∑–∞–≥—Ä—É–∂–µ–Ω');

        // –ñ–¥—ë–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', function() {
            console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');

            const dropZone = document.getElementById('dropZone');
            // –ò—â–µ–º input –ø–æ –∏–º–µ–Ω–∏ –≤–º–µ—Å—Ç–æ ID
            const fileInput = document.querySelector('input[type="file"][name*="avatar"]');
            const chooseFileBtn = document.getElementById('chooseFileBtn');
            const preview = document.getElementById('avatarPreview');
            const fileInfo = document.getElementById('fileInfo');

            console.log('dropZone:', dropZone);
            console.log('fileInput:', fileInput);
            console.log('chooseFileBtn:', chooseFileBtn);

            if (!dropZone || !fileInput || !chooseFileBtn) {
                console.error('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã!');
                console.log('–í—Å–µ input[type=file]:', document.querySelectorAll('input[type="file"]'));
                return;
            }

            // –°–∫—Ä—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π input
            fileInput.style.display = 'none';

            // –ö–Ω–æ–ø–∫–∞ "–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª"
            chooseFileBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('–ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ "–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª"');
                fileInput.click();
            });

            // –ö–ª–∏–∫ –ø–æ –∑–æ–Ω–µ (–Ω–æ –Ω–µ –ø–æ –∫–Ω–æ–ø–∫–µ)
            dropZone.addEventListener('click', function(e) {
                if (e.target.id !== 'chooseFileBtn' && !e.target.closest('#chooseFileBtn')) {
                    console.log('–ö–ª–∏–∫ –ø–æ –∑–æ–Ω–µ –∑–∞–≥—Ä—É–∑–∫–∏');
                    fileInput.click();
                }
            });

            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ input
            fileInput.addEventListener('change', function(e) {
                console.log('–§–∞–π–ª –≤—ã–±—Ä–∞–Ω —á–µ—Ä–µ–∑ input');
                if (e.target.files && e.target.files.length > 0) {
                    handleFiles(e.target.files);
                }
            });

            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è drag & drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);

                document.body.addEventListener(eventName, function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });

            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏
            dropZone.addEventListener('dragenter', function(e) {
                console.log('dragenter');
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragover', function(e) {
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', function(e) {
                console.log('dragleave');
                dropZone.classList.remove('dragover');
            });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ drop
            dropZone.addEventListener('drop', function(e) {
                console.log('drop');
                dropZone.classList.remove('dragover');

                const dt = e.dataTransfer;
                const files = dt.files;

                console.log('–§–∞–π–ª–æ–≤ –ø–µ—Ä–µ—Ç–∞—â–µ–Ω–æ:', files.length);

                if (files.length > 0) {
                    // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π FileList
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(files[0]);
                    fileInput.files = dataTransfer.files;

                    handleFiles(files);
                }
            });

            function handleFiles(files) {
                console.log('handleFiles –≤—ã–∑–≤–∞–Ω, —Ñ–∞–π–ª–æ–≤:', files.length);

                if (files.length === 0) {
                    console.log('–ù–µ—Ç —Ñ–∞–π–ª–æ–≤');
                    return;
                }

                const file = files[0];
                console.log('–§–∞–π–ª:', file.name, file.type, file.size);

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
                if (!file.type.match('image.*')) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                    fileInput.value = '';
                    return;
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º 5 –ú–ë');
                    fileInput.value = '';
                    return;
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
                const fileSizeKB = (file.size / 1024).toFixed(2);
                fileInfo.innerHTML = '<strong>' + file.name + '</strong><br>' + fileSizeKB + ' –ö–ë';
                console.log('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∞');

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                const reader = new FileReader();
                reader.onload = function(e) {
                    console.log('–ü—Ä–µ–≤—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.onerror = function(e) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞:', e);
                };
                reader.readAsDataURL(file);
            }
        });
    </script>
{% endblock %}