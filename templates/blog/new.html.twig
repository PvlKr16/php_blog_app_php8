{% extends 'base.html.twig' %}

{% block title %}–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –±–ª–æ–≥{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .file-upload-area {
            border: 2px dashed #b0b0b0;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background-color: #f9f9f9;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .file-upload-area.dragover {
            border-color: #4a4a4a;
            background-color: #e8e8e8;
        }

        .file-upload-area:hover {
            border-color: #4a4a4a;
            background-color: #f0f0f0;
        }

        .file-upload-icon {
            font-size: 48px;
            color: #8c8c8c;
            margin-bottom: 10px;
        }

        .file-list {
            margin-top: 15px;
            text-align: left;
        }

        .file-item {
            padding: 10px;
            margin-bottom: 5px;
            background-color: #f5f5f5;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item-info {
            flex-grow: 1;
        }

        .file-item-remove {
            color: #dc3545;
            cursor: pointer;
            font-weight: bold;
            padding: 0 10px;
        }

        .file-item-remove:hover {
            color: #a71d2a;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="container mt-4">
        <h1>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –±–ª–æ–≥</h1>

        {{ form_start(form, {'attr': {'enctype': 'multipart/form-data'}}) }}
        {{ form_row(form.title) }}
        {{ form_row(form.category) }}
        {{ form_row(form.status) }}
        {{ form_row(form.participants) }}
        {{ form_row(form.content) }}

        <div class="mb-3">
            <label class="form-label">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª—ã (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>

            <div class="file-upload-area" id="dropZone">
                <div class="file-upload-icon">üìé</div>
                <p class="mb-2"><strong>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞</strong></p>
                <p class="text-muted mb-2">–∏–ª–∏</p>
                <button type="button" class="btn btn-secondary btn-sm" id="chooseFilesBtn">
                    –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã
                </button>
                <div id="fileList" class="file-list"></div>
            </div>

            <div style="display: none;">
                {{ form_widget(form.attachments) }}
            </div>

            <div class="form-text">
                –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (JPG, PNG, GIF, WEBP) - –º–∞–∫—Å. 10 –ú–ë<br>
                –ê—É–¥–∏–æ (MP3, WAV, OGG) - –º–∞–∫—Å. 20 –ú–ë<br>
                –î–æ–∫—É–º–µ–Ω—Ç—ã (PDF, DOC, DOCX, TXT, MD) - –º–∞–∫—Å. 10 –ú–ë<br>
                –î–æ 5 —Ñ–∞–π–ª–æ–≤ –Ω–∞ –±–ª–æ–≥
            </div>
            {{ form_errors(form.attachments) }}
        </div>

        <button type="submit" class="btn btn-primary">{{ button_label|default('–°–æ–∑–¥–∞—Ç—å –±–ª–æ–≥') }}</button>
        <a href="{{ path('blog_list') }}" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
        {{ form_end(form) }}
    </div>
{% endblock %}

{% block javascripts %}
    <script>
        window.addEventListener('load', function() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.querySelector('input[type="file"][name*="attachments"]');
            const chooseFilesBtn = document.getElementById('chooseFilesBtn');
            const fileListDiv = document.getElementById('fileList');

            if (!dropZone || !fileInput || !chooseFilesBtn) {
                console.error('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã!');
                return;
            }

            let selectedFiles = new DataTransfer();

            // –ö–Ω–æ–ø–∫–∞ "–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã"
            chooseFilesBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                fileInput.click();
            });

            // –ö–ª–∏–∫ –ø–æ –∑–æ–Ω–µ
            dropZone.addEventListener('click', function(e) {
                if (e.target.id !== 'chooseFilesBtn' && !e.target.closest('#chooseFilesBtn') && !e.target.closest('.file-item-remove')) {
                    fileInput.click();
                }
            });

            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ input
            fileInput.addEventListener('change', function(e) {
                if (e.target.files && e.target.files.length > 0) {
                    addFiles(e.target.files);
                }
            });

            // Drag & Drop —Å–æ–±—ã—Ç–∏—è
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });

            dropZone.addEventListener('dragenter', function(e) {
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragover', function(e) {
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', function(e) {
                if (e.target === dropZone) {
                    dropZone.classList.remove('dragover');
                }
            });

            dropZone.addEventListener('drop', function(e) {
                dropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    addFiles(files);
                }
            });

            function addFiles(files) {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ñ–∞–π–ª–æ–≤
                if (selectedFiles.files.length + files.length > 5) {
                    alert('–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–∞–∫—Å–∏–º—É–º 5 —Ñ–∞–π–ª–æ–≤');
                    return;
                }

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];

                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
                    const allowedTypes = [
                        'image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp',
                        'audio/mpeg', 'audio/mp3', 'audio/wav', 'audio/ogg',
                        'application/pdf', 'application/msword',
                        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                        'text/plain', 'text/markdown'
                    ];

                    if (!allowedTypes.includes(file.type)) {
                        alert('–§–∞–π–ª "' + file.name + '" –∏–º–µ–µ—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ç–∏–ø');
                        continue;
                    }

                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ (20MB)
                    if (file.size > 20 * 1024 * 1024) {
                        alert('–§–∞–π–ª "' + file.name + '" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º 20 –ú–ë');
                        continue;
                    }

                    selectedFiles.items.add(file);
                }

                updateFileInput();
                displayFiles();
            }

            function updateFileInput() {
                fileInput.files = selectedFiles.files;
            }

            function displayFiles() {
                fileListDiv.innerHTML = '';

                if (selectedFiles.files.length === 0) {
                    return;
                }

                for (let i = 0; i < selectedFiles.files.length; i++) {
                    const file = selectedFiles.files[i];
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';

                    const fileSizeKB = (file.size / 1024).toFixed(2);
                    const icon = getFileIcon(file.type);

                    fileItem.innerHTML = `
                <div class="file-item-info">
                    <span style="font-size: 20px;">${icon}</span>
                    <strong>${file.name}</strong>
                    <span class="text-muted">(${fileSizeKB} KB)</span>
                </div>
                <span class="file-item-remove" data-index="${i}">‚úï</span>
            `;

                    fileListDiv.appendChild(fileItem);
                }

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
                document.querySelectorAll('.file-item-remove').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const index = parseInt(this.getAttribute('data-index'));
                        removeFile(index);
                    });
                });
            }

            function removeFile(index) {
                const newFileList = new DataTransfer();

                for (let i = 0; i < selectedFiles.files.length; i++) {
                    if (i !== index) {
                        newFileList.items.add(selectedFiles.files[i]);
                    }
                }

                selectedFiles = newFileList;
                updateFileInput();
                displayFiles();
            }

            function getFileIcon(mimeType) {
                if (mimeType.startsWith('image/')) return 'üñºÔ∏è';
                if (mimeType.startsWith('audio/')) return 'üéµ';
                if (mimeType.includes('pdf') || mimeType.includes('word') || mimeType.includes('text')) return 'üìÑ';
                return 'üìé';
            }
        });
    </script>
{% endblock %}